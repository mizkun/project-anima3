# fix: シミュレーション制御の状態同期問題を修正

## 問題の概要
フロントエンドのシミュレーション開始ボタンを押すと、以下の問題が発生している：

1. 「シミュレーションは既に実行中です」エラーが発生する場合がある
2. フロントエンドとバックエンドの状態が同期されていない
3. `useSimulationControls`フックの状態管理が不適切

## 現在の問題
- `useSimulationControls`フックでローカル状態を管理しているが、グローバルストア（`useSimulationStore`）と同期されていない
- WebSocketでの状態更新がローカル状態に反映されない
- リセット処理後の状態更新が適切に行われない

## 修正方針
1. `useSimulationControls`フックをグローバルストアベースに変更
2. WebSocketでの状態更新を適切に処理
3. エラーハンドリングを改善
4. 状態の一貫性を保つ

## 実装内容
- `useSimulationControls`フックの状態管理をグローバルストアに統一
- WebSocket接続状態の確認と再接続処理
- エラー状態のクリア処理を改善
- 状態変更時の適切な通知処理

## 期待される効果
- シミュレーション開始時のエラーが解消される
- フロントエンドとバックエンドの状態が常に同期される
- ユーザーエクスペリエンスが向上する

## 実装完了
✅ **修正完了** - 2024年12月19日

### 実装した修正内容：

1. **`useSimulationControls`フックの改善**
   - グローバルストア（`useSimulationStore`）ベースの状態管理に変更
   - 初期化時にバックエンドとの状態同期を追加
   - エラーハンドリングを改善

2. **バックエンドの自動リセット機能**
   - `engine_wrapper.py`の`start_simulation`メソッドで、既に実行中の場合は自動的にリセット
   - 「シミュレーションは既に実行中です」エラーを解消

3. **フロントエンドのエラー表示改善**
   - `SimulationControls`コンポーネントにエラー表示UI追加
   - エラークリア機能を実装

4. **設定の改善**
   - シミュレーション開始時のデフォルト設定を適切に設定

### テスト結果：
- ✅ シミュレーション開始API正常動作確認
- ✅ 連続でシミュレーション開始リクエストを送信しても自動リセットが動作
- ✅ エラー「シミュレーションは既に実行中です」が解消
- ✅ 状態同期が正常に動作

### 影響範囲：
- `web/frontend/src/hooks/useSimulationControls.ts` - 状態管理をグローバルストアベースに変更
- `web/frontend/src/components/Controls/SimulationControls.tsx` - エラー表示UI追加
- `web/backend/services/engine_wrapper.py` - 自動リセット機能追加

**Issue完了 - 問題は解決されました。** 