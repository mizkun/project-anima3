# feat: タイムライン表示同期問題の修正

## 問題の概要
ターン実行ボタンを押してもタイムラインに何も表示されない。WebSocketでのタイムライン更新が正しく動作していない。

## 現象
- Next Turnボタンを押してもタイムラインに反映されない
- バックエンドではターン実行が成功している
- WebSocketメッセージの形式が不一致
- Gemini APIのJSONパースエラーが発生

## 原因分析
1. **WebSocketメッセージ形式の不一致**
   - バックエンド: `turn_completed`メッセージ
   - フロントエンド: 異なるメッセージ形式を期待

2. **タイムライン更新ロジックの問題**
   - シミュレーションストアとタイムラインフックの連携不足
   - WebSocketメッセージハンドラーの不整合

3. **Gemini APIレスポンスの問題**
   - JSONに制御文字が含まれてパースエラー

## 修正方針
1. **WebSocketメッセージ形式の統一**
   - バックエンドとフロントエンドのメッセージ形式を統一
   - タイムライン更新用の専用メッセージを追加

2. **タイムライン表示の改善**
   - シミュレーションストアからタイムラインデータを取得
   - リアルタイム更新の確実な動作

3. **Gemini APIエラーの修正**
   - JSONレスポンスのクリーニング処理を改善

## 実装タスク
- [x] WebSocketメッセージハンドラーの修正
- [x] タイムライン表示ロジックの改善
- [x] シミュレーションストアとの連携強化
- [x] Gemini APIレスポンス処理の改善

## 実装内容
1. **WebSocketメッセージ形式の統一**
   - `turn_completed`メッセージの処理を追加
   - タイムライン更新用のメッセージハンドラーを実装
   - WebSocketメッセージの型定義を更新

2. **タイムライン表示の改善**
   - `Timeline.tsx`をシミュレーションストアから直接データを取得するように修正
   - `TimelineEntry`型定義をバックエンドの形式に合わせて更新
   - `ActionDisplay.tsx`を新しい形式に対応（思考・行動・発言を分割表示）

3. **Next Turnボタンの表示条件修正**
   - `running`状態でもNext Turnボタンが表示されるように修正
   - ステップ実行機能が正常に動作することを確認

4. **Gemini APIエラーの修正**
   - モデル名を`gemini-pro`から`gemini-1.5-flash`に更新
   - `_clean_json_response`メソッドで制御文字の除去処理を追加
   - JSONパースエラー時のデバッグログを改善（`repr()`を追加）

5. **UI改善**
   - 「結果を見る」ボタンを削除し、リアルタイム表示の説明に変更

## テスト結果
- シミュレーション開始: 正常動作
- Next Turn実行: 正常動作（2ターン連続実行成功）
- タイムライン表示: 思考・行動・発言が正しく分割表示
- Gemini API: エラー解決、正常なJSON応答を取得
- WebSocket通信: 正常動作

## 受け入れ条件
- [x] Next Turnボタンでタイムラインが更新される
- [x] WebSocketでリアルタイム更新が動作する
- [x] Gemini APIエラーが解消される
- [x] 思考・行動・発言が適切に分割表示される
- [x] フロントエンドからのステップ実行が可能 