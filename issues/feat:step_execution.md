## タスク概要 (Summary)

* **タスクリスト番号**: (例: `[ ] 7.1. ターン進行のユーザー介入化と介入機能の本格実装` - 新しいタスク番号を割り振ってください)
* **担当モジュール/ファイル**:
    * `project_anima/core/simulation_engine.py` (既存ファイルを大幅に修正)
    * `project_anima/interactive_cli.py` (新規ファイル)
    * `interactive.py` (新規エントリポイント)
* **関連する詳細仕様書セクション**:
    * 「詳細仕様書 3.2.3. ユーザーによる介入」
    * 「タスク5.3で実装したユーザー介入機能の基盤」
* **このタスクのゴール**:
    1. `SimulationEngine` の `start_simulation` メソッドにおけるターン進行を、現在の自動進行から、ユーザーが各ターンの実行を指示する形式（例: "next" コマンド入力など）に変更する。
    2. 各ターンの合間に、ユーザーが詳細仕様書で定義された介入（場面状況の変更、キャラクターへの天啓付与、キャラクターの追加/削除、場面の終了など）を実行できる明確なインターフェース（コンソールベース）を提供する。
    3. `SimulationEngine.process_user_intervention` メソッドを拡張し、より多様な介入指示を解釈し、対応する処理を確実に実行できるようにする。

## 背景と目的 (Background and Purpose)

* 現在のシミュレーションは、一度開始すると指定されたターン数まで自動で進行する。しかし、よりインタラクティブな物語生成やデバッグのためには、ユーザーが各ターンの進行をコントロールし、任意のタイミングで状況に介入できる機能が求められる。
* これにより、ユーザーはシミュレーションの展開をより細かく制御し、特定の状況を作り出したり、キャラクターの反応を試したりすることが容易になる。

## 実装する機能の詳細 (Detailed Functionality to Implement)

* **1. `project_anima/interactive_cli.py` (インタラクティブCLI) の実装**:
    * シミュレーション開始後、ユーザーからのコマンド入力を受け付けるループを設ける。
    * **ユーザーコマンドの定義 (例)**:
        * `next` (または `n`): 次の1ターンを実行する。
        * `intervene` (または `i`): 介入モードに入り、さらに詳細な介入コマンドを受け付ける。
        * `status` (または `s`): 現在の場面情報、ターン数、参加キャラクターなどを表示する。
        * `quit` (または `q`): シミュレーションを終了する。
    * `intervene` コマンドが入力された場合、サブコマンドとして介入の種類（例: `update_situation`, `give_revelation`, `add_char`, `remove_char`, `end_scene`）と、必要な引数（例: 新しい状況説明文、対象キャラクターID、天啓内容など）をユーザーから受け付ける。
    * 受け付けた介入指示を整形し、`SimulationEngine.process_user_intervention` に渡すための `InterventionData` オブジェクトを生成する。

* **2. `project_anima/core/simulation_engine.py` の修正**:
    * **`start_simulation` メソッドの大幅な変更**:
        * 自動でターンを進行させるループではなく、`interactive_cli` からの指示（例: `next` コマンド）があるたびに1ターンだけ実行するように変更する。
        * 外部から `process_user_intervention` を呼び出せるようにする。
        * 場面終了フラグ (`_end_scene_requested`) を参照し、これが `True` になったらシミュレーションを終了する。
        * `start_simulation` は初期化と場面ロードのみを行い、実際のターン進行は新しいパブリックメソッド `execute_one_turn()` と `process_intervention_command(command_str)` のような形で行う。
    * **`process_user_intervention` メソッドの拡張**:
        * `interactive_cli` から渡された整形済みの `InterventionData` (またはコマンド文字列と引数) を解釈し、タスク5.3で実装した各介入処理（`SceneManager` のメソッド呼び出し、`_pending_revelations` の更新、`_end_scene_requested` の設定など）を確実に実行する。
        * 各介入タイプ (`ADD_CHARACTER_TO_SCENE`, `REMOVE_CHARACTER_FROM_SCENE`, `END_SCENE` など) のスタブ実装を本格的な実装に置き換える。
            * キャラクター追加/削除の場合は、`CharacterManager` でのデータロード確認や、`SceneManager` および `_current_scene_log.scene_info.participant_character_ids` の整合性を取る処理を確実に行う。
        * 介入処理の結果（成功/失敗、変更内容など）をログに出力する。
    * **状態表示メソッドの追加**:
        * `get_simulation_status()` のようなメソッドを追加し、現在のターン数、行動順、場面の状況などを整形して返す。`interactive_cli` の `status` コマンドで利用する。

---

## テストケース (Test Cases)

**(このタスクの完了を確認するためのテストケースをTDDの観点から記述)**

### `SimulationEngine` と `interactive_cli` の連携テスト (手動テストまたは自動化されたE2Eテストを想定)

1.  **テストケース1: 1ターンずつの進行**
    * **操作手順**: `interactive.py` を起動し、"next" コマンドを数回入力する。
    * **期待される結果**: 各コマンド入力後に1ターンずつシミュレーションが進行し、キャラクターの思考・行動・発言がログに出力されること。
2.  **テストケース2: 場面状況更新の介入**
    * **操作手順**: `interactive.py` を起動し、数ターン進行させた後、「intervene update_situation 新しい状況です」のようなコマンドを入力。その後 "next" コマンドでターンを進行。
    * **期待される結果**: `SceneManager` が状況を更新し、その後のキャラクターの思考が新しい状況を（ある程度）反映していること。介入がログに記録されること。
3.  **テストケース3: 天啓付与の介入**
    * **操作手順**: `interactive.py` を起動し、対象キャラクターと天啓内容を指定して「intervene give_revelation ...」のようなコマンドを入力。その後、対象キャラクターのターンが来るまで "next" コマンドで進行。
    * **期待される結果**: 対象キャラクターの思考コンテクストに天啓内容が含まれ、思考が変化すること。介入がログに記録されること。
4.  **テストケース4: キャラクター追加・削除の介入**
    * **操作手順**: 途中でキャラクターを追加/削除する介入コマンドを入力。
    * **期待される結果**: 参加キャラクターリストが変更され、その後のターン進行に反映されること。
5.  **テストケース5: 場面終了の介入**
    * **操作手順**: 「intervene end_scene」のようなコマンドを入力。
    * **期待される結果**: シミュレーションが正常に終了し、ログが保存されること。

## 完了の定義 (Definition of Done)

* [x] `interactive.py` (エントリーポイント) と `project_anima/interactive_cli.py` で、ユーザーがコマンド (`next`, `intervene`, `status`, `quit`) を入力してシミュレーションを制御できる。
* [x] `SimulationEngine.start_simulation` が、ユーザーの `next` 指示に基づいて1ターンずつ進行するように修正されている。
* [x] `SimulationEngine.process_user_intervention` が、主要な介入タイプ（場面状況更新、天啓付与、キャラクター追加/削除、場面終了）を処理し、関連モジュールと連携してシミュレーション状態を正しく更新する。
* [x] 介入タイプに応じた適切な介入コマンドの処理がされている。
* [x] ユーザー介入の情報は場面ログに正しく記録される。
* [x] 関連するエラーハンドリングが適切に実装されている。
* [x] 各メソッドには適切な型ヒントとdocstringが付与されている。
* [ ] 上記テストケースを満たすテストが実施され、主要な動作が確認されている。
* [x] コードに明らかなバグや非効率な箇所がない。

## 備考 (Notes)

* このタスクの完了により、「Project Anima」はユーザーがより能動的に関与できる、真のインタラクティブ・シミュレーターへと大きく進化します！
* ユーザーインターフェースはコンソールベースですが、将来的にWeb UIなどに拡張する際にも、この `SimulationEngine` のインターフェースが役立つはずです。
* 「天啓付与」のコンテクストへの影響は、`ContextBuilder` との連携が鍵となります。