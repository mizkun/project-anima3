## タスク概要 (Summary)

* **タスクリスト番号**: `[ ] 3.3. ログ出力機能 (core/simulation_engine.py, utils/file_handler.py)`
* **担当モジュール/ファイル**: 
  * `core/simulation_engine.py` (_save_scene_logメソッド)
  * `utils/file_handler.py` (既存のファイル)
* **関連する詳細仕様書セクション**:
  * 「詳細仕様書 3.2.2 短期情報(ログファイル構造)」
* **このタスクのゴール**: 場面終了時に、メモリ上の短期ログ（場面ログ）を指定されたJSON/YAML形式でファイルに出力する機能を実装する。

## 背景と目的 (Background and Purpose)

* シミュレーション実行中に生成されたターン情報やユーザー介入情報を、永続的に保存する必要がある。
* 保存されたログは、後で分析したり、シミュレーションを再開する際の入力として使用できる。
* シミュレーションの結果を確認し、デバッグするためにも重要な機能である。

## 実装する機能の詳細 (Detailed Functionality to Implement)

* **入力**:
  * `_save_scene_log` メソッド（`SimulationEngine`クラス内）:
    * `self._current_scene_log`: 現在のシミュレーションの場面ログデータ（`SceneLogData`オブジェクト）

* **処理内容**:
  1. 現在の場面ログデータが有効かどうか確認する。
  2. 保存先ディレクトリ（`logs/<simulation_id>/`）を作成する。
     * `<simulation_id>`は、タイムスタンプを含む一意のIDを生成する。
     * 例: `logs/sim_20250522_150000/`など。
  3. 保存するファイル名を決定する。
     * 例: `scene_{scene_id}.json`
  4. ファイル形式（JSONまたはYAML）に応じて、ログデータをシリアライズする。
     * `utils/file_handler.py`の`save_json`関数または`save_yaml`関数を使用する。
  5. シリアライズされたデータをファイルに書き込む。
  6. ログ出力の結果をコンソールに表示する。

* **出力/返り値**:
  * `_save_scene_log`: なし
  * 副作用として、ログファイルがディスク上に作成される。

* **エラーハンドリング**:
  * ディレクトリ作成に失敗した場合のエラー処理。
  * ファイル書き込みに失敗した場合のエラー処理。
  * ログデータが無効な場合のエラー処理。

* **考慮事項**:
  * ログファイルの形式はJSONをデフォルトとするが、将来的にYAMLも対応できるようにしておく。
  * ログディレクトリやファイル名のパターンは、設定可能にしておくと良い。
  * 大量のログデータを効率的に保存できるように考慮する。

## テストケース (Test Cases)

### 前提: テストデータの準備
* テスト用のSceneLogDataオブジェクトを作成する。

### 正常系テスト

1. **テストケース1: 基本的なログ保存機能が動作する**
   * **前提条件/入力**: `SimulationEngine`インスタンスが正常に初期化され、シミュレーションが実行され、`self._current_scene_log`にデータが格納されている。
   * **操作手順**: `engine._save_scene_log()`を実行する。
   * **期待される結果**:
     * `logs/`ディレクトリ内に新しいサブディレクトリが作成される。
     * そのサブディレクトリ内に、シーンIDを含むファイル名でJSONファイルが作成される。
     * ファイルの内容が`self._current_scene_log`の内容と一致する。
     * ファイルが有効なJSONであり、適切なフォーマットになっている。

### 異常系テスト

1. **テストケース1: 場面ログが存在しない場合**
   * **前提条件/入力**: `self._current_scene_log`が`None`の状態。
   * **操作手順**: `engine._save_scene_log()`を実行する。
   * **期待される結果**: エラーログが出力され、ファイルは作成されない。

2. **テストケース2: ディレクトリ作成に失敗する場合**
   * **前提条件/入力**: ディレクトリ作成権限がない、またはディスクスペースが不足している状態を模擬する。
   * **操作手順**: `engine._save_scene_log()`を実行する。
   * **期待される結果**: 適切なエラーメッセージがログに出力され、例外が適切に処理される。

## 完了の定義 (Definition of Done)

* [ ] `core/simulation_engine.py`の`_save_scene_log`メソッドが実装されている。
* [ ] 実装が「詳細仕様書 3.2.2 短期情報(ログファイル構造)」に従っている。
* [ ] シミュレーション終了後（または場面終了時）に、`logs/<simulation_id>/scene_<scene_id>.json`（または`.yaml`）が生成される。
* [ ] 上記テストケース（正常系・異常系）を満たすユニットテストが作成され、全て成功する。
* [ ] ログファイルの内容が確認でき、シミュレーション結果が正しく記録されている。
* [ ] エラーハンドリングが適切に実装されている。

## 備考 (Notes)

* このタスクは、シミュレーション結果の永続化に関する基本的な機能を実装するものです。
* 将来的には、より詳細なログ出力や、ログからのシミュレーション再開機能なども検討されます。
* ログフォーマットは、将来的な拡張性を考慮して設計する必要があります。 