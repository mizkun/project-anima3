# fix: 複数キャラクターのシミュレーション表示問題

## 問題の詳細

シミュレーションで複数のキャラクター（燐子と芽衣）が設定されているシーンにも関わらず、燐子のターンしか表示されず、芽衣のターンが表示されない。

## 現在の状況

- シーンファイル（school_rooftop.yaml）には両方のキャラクターが設定されている
  - `rinko_kizuki_002`
  - `mei_kinoshita_001`
- 両方のキャラクターファイルが正しく存在する
- シミュレーションエンジンは正常に動作している

## 調査結果

1. **シミュレーションエンジンの実装は正常**
   - `_determine_next_character()`はラウンドロビン方式で正常に動作
   - `participant_character_ids`に基づいて順番に処理

2. **API設定の不整合**
   - `character_name`パラメータが使用されているが、実際のシミュレーションではシーンの`participant_character_ids`を使用
   - 設定とシミュレーション動作に齟齬がある

3. **フロントエンドタイムライン実装確認済み**
   - `Timeline.tsx`は複数キャラクターの表示に対応している
   - ターンアイテムは`turn.character`プロパティで表示される
   - フィルタリング機能は実装されていない

## 考えられる原因

1. **フロントエンドの表示問題**
   - タイムライン表示でキャラクターフィルタリングが発生
   - 特定のキャラクターのみ表示している可能性

2. **ターン実行の問題**
   - 手動制御での連続実行時に適切にターンが進んでいない
   - `_current_turn`インデックスが正しく更新されていない

3. **エラーハンドリング**
   - 1番目のキャラクター（芽衣）でエラーが発生して次に進んでいない
   - エラーログが適切に確認されていない

## 修正方針

1. バックエンドのログ出力を詳細化 ✅
2. フロントエンドのタイムライン表示ロジックを確認 ✅
3. ターン実行処理のデバッグ情報を追加 ✅
4. エラーハンドリングの改善

## 実装済み

- [x] `EngineWrapper.execute_next_turn()`に詳細ログを追加
  - ターン実行前後の状況をログ出力
  - 参加キャラクター一覧の確認
  - 次のキャラクター情報の表示
  - ターン実行結果の詳細記録

## 次の確認手順

1. **シミュレーション実行テスト**
   ```bash
   # バックエンドサーバー起動（別ターミナル）
   python web/backend/run_server.py
   
   # フロントエンドサーバー起動（別ターミナル）
   cd web/frontend && npm run dev
   ```

2. **ログ確認ポイント**
   - シミュレーション開始時の参加キャラクター
   - 各ターン実行前の状況
   - 実行されたキャラクター名
   - 次のターンで実行予定のキャラクター
   - エラーメッセージの有無

3. **フロントエンド確認ポイント**
   - タイムラインに表示されるキャラクター名
   - ターン番号の連続性
   - `character_id`と`character_name`の一致

4. **データ確認**
   - `/api/simulation/status`のレスポンス内容
   - `timeline`配列の各エントリの`character`フィールド
   - `metadata`に含まれるキャラクター情報

## タスク

- [x] シミュレーション実行時の詳細ログを確認
- [ ] 実際のシミュレーション実行テスト
- [ ] ログ分析とエラー特定
- [ ] 必要に応じた修正実装
- [ ] テストケースの作成 