# feat: 物語作成ワークフロー実装 - ユーザーが物語を作り始められる状態の実現

## 1. Issue種別 (Issue Type)

* [ ] バグ修正 (Bug Fix)
* [ ] 機能改善 (Enhancement)
* [x] 新規機能 (New Feature)
* [ ] リファクタリング (Refactoring)
* [ ] ドキュメント (Documentation)
* [ ] その他 (Other: {{specify}})

## 2. 優先度 (Priority)

* [x] 高 (High)
* [ ] 中 (Medium)
* [ ] 低 (Low)

## 3. タイトル (Title)

* feat: 物語作成ワークフロー実装 - ユーザーが物語を作り始められる状態の実現

## 4. 問題の概要 (Problem Overview)

現在のProject Animaは技術的な基盤は整っているが、エンドユーザーが実際に物語を作成するための包括的なワークフローが不足している。ユーザーが「物語を作り始めることができる状態」を実現するために、以下の機能群を統合的に実装する必要がある。

## 5. 目標 (Goal)

**「ユーザーとしてこのサービスを使って物語を作り始めることができる状態」の実現**

## 6. 現状分析結果 (Current Status Analysis)

### ✅ 既に実装済みの機能
1. **シミュレーション実行機能**
   - シーン選択機能
   - シミュレーション開始・ターン実行
   - タイムライン表示
   - 介入機能

2. **バックエンドAPI**
   - ファイル管理API（`/api/files`）
   - シミュレーション制御API（`/api/simulation`）
   - キャラクター・シーン一覧取得

### ⚠️ 問題のある機能
1. **ファイル編集機能**
   - プロンプト編集（バグあり）
   - キャラクター編集（バグあり）
   - Monaco Editorを使用した高機能エディター（動作不安定）
   - ファイル作成・保存・読み込み機能（バグあり）

### ❌ 不足している機能
1. **シーン編集機能**
   - シーンファイルの作成・編集UI（FileEditorでアクセス不可）
   - シーン情報の構造化編集

2. **キャラクター管理UI**
   - キャラクター作成・編集の専用UI
   - キャラクター情報の構造化編集

3. **エクスポート機能**
   - シミュレーション結果のエクスポート
   - 複数結果の選択・統合

4. **過去シミュレーション管理**
   - 過去の結果閲覧・再開機能

## 7. 今日の具体的TODOリスト (Today's TODO List)

### 🚨 優先度1: ファイル編集機能のバグ修正（2時間）
- [ ] **バグ調査**: ファイル編集機能の具体的な問題を特定
  - FileEditorでファイルが読み込めない問題
  - ファイル保存時のエラー
  - ディレクトリアクセス権限の問題
- [ ] **バックエンドAPI修正**: `web/backend/api/files.py`の問題修正
  - シーンディレクトリ（`data/scenes`）へのアクセス許可
  - 4箇所の`allowed_dirs`配列に`"data/scenes"`を追加
  - ファイル読み書き処理のエラーハンドリング改善
- [ ] **フロントエンド修正**: FileEditorの動作を安定化
  - `web/frontend/src/components/Editors/FileSelector.tsx`の修正
  - `web/frontend/src/components/Editors/EditorContainer.tsx`のエラーハンドリング改善
  - `web/frontend/src/hooks/useFileManager.ts`の修正

### 🎯 優先度2: 基本ワークフローテスト（1時間）
- [ ] **ファイル編集テスト**: 修正後のFileEditorで以下をテスト
  - プロンプトファイルの編集・保存
  - キャラクターファイルの編集・保存
  - シーンファイルの編集・保存
- [ ] **シミュレーション実行テスト**: 既存機能が正常に動作することを確認
  - シーン選択
  - シミュレーション開始
  - ターン実行
  - 結果表示

### 🎯 優先度3: テンプレート改善（30分）
- [ ] **シーンテンプレート作成**: 新規シーン作成時の実用的なテンプレート
- [ ] **キャラクターテンプレート作成**: 新規キャラクター作成用の実用的なテンプレート
- [ ] **プロンプトテンプレート確認**: 既存プロンプトの内容確認と改善提案

### 🎯 優先度4: エンドツーエンドテスト（30分）
- [ ] **基本ワークフローテスト**: 以下の一連の流れをテスト
  1. 新しいキャラクターを作成
  2. 新しいシーンを作成
  3. プロンプトを確認・調整
  4. シミュレーションを実行
  5. 結果を確認
- [ ] **問題点の洗い出し**: 上記テストで発見された問題点をリスト化

### 🎯 優先度5: エクスポート機能設計（30分）
- [ ] **エクスポート要件定義**: どのような形式でエクスポートするかを決定
  - JSON形式？ZIP形式？
  - 含める情報の範囲（シーン、キャラクター、シミュレーション結果）
- [ ] **APIエンドポイント設計**: エクスポート用のAPIエンドポイント仕様を設計

## 8. 必要な機能 (Required Features)

### 1. プロンプト調整機能
- [ ] UI上でプロンプトの調整ができる（バグ修正が必要）
- [ ] プロンプトは全体共通のもの（`data/prompts`で管理、アクセス修正が必要）

### 2. キャラクター編集機能
- [ ] キャラクター情報の変更（FileEditorのバグ修正が必要）
- [ ] キャラクター自体の追加（テンプレート改善が必要）

### 3. 場面編集機能
- [ ] 場面の追加（バックエンドAPI修正が必要）
- [ ] 場面情報の変更（バックエンドAPI修正が必要）

### 4. シミュレーション実行機能
- [x] 場面を選択してのシミュレーションの実行（実装済み）
- [ ] 過去に行ったシミュレーション内容の閲覧、再開（未実装）

### 5. シミュレーション結果エクスポート機能
- [ ] いくつかのシミュレーション結果を選択してシーン情報やキャラクター情報と一緒にエクスポートする（未実装）

### 6. UI調整
- [ ] 上記機能に適したUIの調整（段階的に実施）

## 9. 実装計画 (Implementation Plan)

### フェーズ1: 現状分析と基盤整備 ✅
- [x] 現在の機能状況の詳細調査
- [x] 既存のファイル編集機能の確認（バグ発見）
- [x] 必要なAPIエンドポイントの洗い出し

### フェーズ2: バグ修正と基本機能実装（今日実施）
- [ ] ファイル編集機能のバグ修正（最優先）
- [ ] プロンプト編集機能の安定化
- [ ] キャラクター編集機能の安定化
- [ ] 場面編集機能の実装

### フェーズ3: ワークフロー統合（今日実施）
- [ ] 基本ワークフローのテスト
- [ ] 結果の閲覧・管理機能
- [ ] エクスポート機能（設計のみ）

### フェーズ4: UI統合と最適化（次回以降）
- [ ] 一貫したユーザー体験の実現
- [ ] ワークフローの最適化

## 10. 完了の定義 (Definition of Done)

- [ ] ファイル編集機能が正常に動作する
- [ ] ユーザーがWebUIから新しいキャラクターを作成できる
- [ ] ユーザーがWebUIから新しい場面を作成できる
- [ ] ユーザーがWebUIからプロンプトを調整できる
- [x] ユーザーが場面を選択してシミュレーションを実行できる
- [ ] ユーザーが過去のシミュレーション結果を閲覧できる
- [ ] ユーザーがシミュレーション結果をエクスポートできる
- [ ] 上記の一連の流れが直感的に操作できる

## 11. 今日の作業時間見積もり (Time Estimation)

- **ファイル編集機能のバグ修正**: 2時間（最優先）
- **基本ワークフローテスト**: 1時間
- **テンプレート改善**: 30分
- **エンドツーエンドテスト**: 30分
- **エクスポート機能設計**: 30分

**合計**: 約4.5時間

## 12. 緊急対応事項 (Urgent Issues)

### 🚨 ファイル編集機能のバグ
- **症状**: ファイルの読み込み・保存・作成に問題がある
- **影響**: プロンプト・キャラクター・シーンの編集ができない
- **対応**: 最優先でバグ修正を実施

### 📋 調査が必要な項目
- [ ] 具体的なエラーメッセージの確認
- [ ] ブラウザのコンソールエラーの確認
- [ ] バックエンドのログ確認
- [ ] APIエンドポイントの動作確認

## 13. 備考 (Notes)

- **最優先**: ファイル編集機能のバグ修正
- UIは後で調整可能なので、まずは機能面を重視
- 既存の技術基盤を最大限活用
- 段階的な実装でユーザーフィードバックを得ながら進める
- 今日はファイル編集機能を安定化させることを最重要目標とする 