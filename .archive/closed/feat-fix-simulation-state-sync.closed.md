# feat: シミュレーション状態同期問題の修正

## 問題の概要
シミュレーション開始ボタンを押すと「シミュレーションは既に実行中です」エラーが発生する。フロントエンドとバックエンドの状態が同期していない。

## 現象
- 最初のシミュレーション開始は成功するが、その後の開始ボタンクリックでエラー
- フロントエンドでは`status='idle'`と認識、バックエンドでは`status='running'`のまま
- WebSocket接続の頻繁な切断・再接続が発生

## 原因分析
1. シミュレーション状態のリセット処理が不完全
2. WebSocket切断時の状態同期が不十分
3. フロントエンドとバックエンドの状態管理の不整合

## 修正方針
1. **状態強制リセット機能の追加**
   - バックエンドに状態を強制的にIDLEにリセットするエンドポイントを追加
   - フロントエンドの開始ボタンで、まず状態をリセットしてから開始

2. **状態同期の改善**
   - WebSocket接続時に現在の状態を確実に同期
   - フロントエンドの状態管理を改善

3. **エラーハンドリングの改善**
   - 既に実行中の場合は、まず停止してから開始するオプションを提供

## 実装タスク
- [x] バックエンドに`/api/simulation/reset`エンドポイントを追加
- [x] フロントエンドの開始処理を改善（状態確認→リセット→開始）
- [x] WebSocket接続時の状態同期処理を追加
- [x] エラーハンドリングの改善

## 実装内容
1. **バックエンド修正**
   - `EngineWrapper.reset_simulation()`メソッドを追加
   - `/api/simulation/reset`エンドポイントを追加
   - WebSocket通知で`simulation_reset`イベントを送信

2. **フロントエンド修正**
   - `useSimulationControls`で開始前に自動リセットを実行
   - WebSocket接続時に状態同期を実行
   - WebSocketメッセージハンドラーにリセット/開始/停止イベントを追加
   - 型定義を更新してリンターエラーを解消

3. **テスト結果**
   - リセットエンドポイント: 正常動作確認
   - 開始エンドポイント: 正常動作確認
   - 既に実行中での開始: 期待通りエラー発生
   - リセット→開始の流れ: 正常動作確認

## 受け入れ条件
- [x] シミュレーション開始ボタンが確実に動作する
- [x] フロントエンドとバックエンドの状態が常に同期している
- [x] WebSocket切断後の再接続時も状態が正しく同期される

## 完了
修正が完了し、シミュレーション開始ボタンの問題が解決されました。 