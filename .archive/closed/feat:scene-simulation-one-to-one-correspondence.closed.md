## 1. Issue種別 (Issue Type)

* [ ] バグ修正 (Bug Fix)
* [ ] 機能改善 (Enhancement)
* [x] 新規機能 (New Feature)
* [ ] リファクタリング (Refactoring)
* [ ] ドキュメント (Documentation)
* [ ] その他 (Other: {{specify}})

## 2. 優先度 (Priority)

* [x] 高 (High)
* [ ] 中 (Medium)
* [ ] 低 (Low)

## 3. タイトル (Title)

* 場面とシミュレーションの1対1対応化とタイムライン場面作成機能の実装

## 4. 問題の概要 (Problem Overview)

* 現在の仕様では場面（Scene）とシミュレーションが別の概念で、1対1対応ではない
* 事前に作成された場面ファイルを選択してシミュレーションを開始する方式
* 物語の状況が進行していく本来のあり方を考えると、場面とシミュレーションは1対1であるべき
* タイムライン画面からその場で場面を作成し、シミュレーション開始できるようにしたい
* 過去のシミュレーション履歴から再開できる仕組みが欲しい（LINEのトーク画面のような感覚）

## 5. 発見バージョン/関連機能 (Version/Related Feature)

* **バージョン**: 現在のバージョン
* **関連する詳細仕様書セクション**: シミュレーション管理、場面管理、履歴機能
* **関連するタスクリスト番号**: N/A（新規機能）

## 6. 発生条件 / 再現手順 (Conditions / Steps to Reproduce)

**(現在の仕様の制限事項)**

1. タイムライン画面でシミュレーションを開始するには、事前に場面ファイルを作成する必要がある
2. 場面とシミュレーションが独立しているため、物語の進行に伴う場面の変化を表現しづらい
3. 過去のシミュレーションを再開する機能がない
4. 履歴管理が場面中心ではなくシミュレーション中心

## 7. 期待される動作 (Expected Behavior)

* タイムライン画面からその場で場面設定（場面ID、場所、時間、状況、参加キャラクター）を入力してシミュレーション開始
* シミュレーションごとに固有の場面が設定され、1対1対応する
* 過去のシミュレーション履歴から任意の場面を選択して再開可能
* 履歴は場面履歴として管理され、LINEのトーク画面のように扱える
* シミュレーション開始時のタイムスタンプが記録される

## 8. 実際の動作 / 現在の状況 (Actual Behavior / Current Situation)

* 場面ファイル（YAML）を事前に作成し、シミュレーション開始時に既存ファイルから選択する方式
* 場面とシミュレーションが別概念のため、継続的な物語進行を表現しづらい
* シミュレーション履歴はあるが、場面中心の履歴管理ではない
* 過去のシミュレーションを再開する機能がない

---

### 9. 原因調査 / 分析 (Cause Analysis by AI Assistant: Cursor)

* **調査した箇所**:
    * `src/project_anima/core/simulation_engine.py` - シミュレーション管理
    * `src/project_anima/core/scene_manager.py` - 場面管理
    * `web/backend/services/engine_wrapper.py` - バックエンドAPI
    * `web/frontend/src/components/Timeline/Timeline.tsx` - タイムライン画面
    * `web/backend/api/simulation.py` - 履歴管理API
* **特定された原因 (仮説を含む)**:
    * 現在の設計では場面ファイルが静的に管理されている
    * シミュレーション開始時に既存の場面ファイルを読み込む設計
    * 履歴管理がシミュレーション中心で、場面中心ではない
    * タイムライン画面に場面作成機能がない
    * 履歴からの再開機能が実装されていない

### 10. 提案される解決策 / 改善案 (Proposed Solution / Improvement by AI Assistant: Cursor)

* **基本的な方針**:
    * 場面とシミュレーションを1対1対応させる設計に変更
    * タイムライン画面に場面作成ダイアログを追加
    * 履歴を場面履歴として管理し、再開機能を実装
    * 動的な場面作成機能を実装
* **具体的な変更点**:
    * 新しいデータモデル（SceneHistoryEntry）の実装
    * SceneHistoryManagerクラスの新規作成
    * SimulationEngineの動的場面作成・履歴再開機能の追加
    * タイムライン画面に場面作成ダイアログの実装
    * 履歴一覧表示の改善
    * 新しいバックエンドAPIエンドポイントの実装

### 11. 実装計画 / タスク分割 (Implementation Plan / Sub-tasks by AI Assistant: Cursor)

#### Phase 1: 基盤構築 ✅ 完了
1. **[x] 新しいデータモデルの実装**
   * **変更対象ファイル**: `src/project_anima/core/data_models.py`
   * **具体的な変更内容**: SceneHistoryEntryデータクラスの追加

2. **[x] SceneHistoryManagerクラスの作成**
   * **変更対象ファイル**: `src/project_anima/core/scene_history_manager.py`
   * **具体的な変更内容**: 場面履歴の管理・保存・読み込み機能

3. **[x] 動的場面作成機能の実装**
   * **変更対象ファイル**: `src/project_anima/core/scene_manager.py`
   * **具体的な変更内容**: create_scene_dynamicallyメソッドの追加

#### Phase 2: シミュレーション管理 ✅ 完了
4. **[x] SimulationEngineの拡張**
   * **変更対象ファイル**: `src/project_anima/core/simulation_engine.py`
   * **具体的な変更内容**: 履歴からの再開機能、一時停止・再開機能の実装

5. **[x] バックエンドAPIの実装**
   * **変更対象ファイル**: `web/backend/api/simulation.py`
   * **具体的な変更内容**: 場面履歴関連の新しいエンドポイント追加

6. **[x] EngineWrapperの拡張**
   * **変更対象ファイル**: `web/backend/services/engine_wrapper.py`
   * **具体的な変更内容**: 場面履歴管理機能の統合

#### Phase 3: フロントエンド改修 ✅ 完了
7. **[x] 場面作成ダイアログの実装**
   * **変更対象ファイル**: `web/frontend/src/components/Timeline/SceneCreationDialog.tsx`
   * **具体的な変更内容**: 新規場面作成用のモーダルダイアログ

8. **[x] 履歴一覧表示の改善**
   * **変更対象ファイル**: `web/frontend/src/components/Timeline/SceneHistoryList.tsx`
   * **具体的な変更内容**: 場面履歴のカード表示と再開機能

9. **[x] タイムライン画面のUI刷新**
   * **変更対象ファイル**: `web/frontend/src/components/Timeline/EnhancedTimeline.tsx`, `web/frontend/src/utils/sceneApi.ts`
   * **具体的な変更内容**: 場面作成ボタンの追加、履歴表示の統合、API連携

#### Phase 4: 統合とテスト ✅ 完了
10. **[x] フロントエンドとバックエンドの統合**
    * **変更対象ファイル**: `web/frontend/src/App.tsx`, `web/frontend/src/pages/SimulationPage.tsx`
    * **具体的な変更内容**: EnhancedTimelineコンポーネントの統合、既存Timeline置き換え

11. **[x] 既存アプリケーションへの統合**
    * **変更対象ファイル**: メインアプリケーション
    * **具体的な変更内容**: 新機能をメインアプリケーションに統合し、動作確認

### 12. テスト計画 (Test Plan by AI Assistant: Cursor)

* **ユニットテスト**:
    * SceneHistoryManagerクラスのテスト
    * 動的場面作成機能のテスト
    * 履歴再開機能のテスト
* **結合テスト/手動テスト**:
    * タイムライン画面からの場面作成テスト
    * 履歴からの再開テスト
    * 既存機能との互換性テスト
    * 複数場面の並行管理テスト

---

## 13. 完了の定義 (Definition of Done)

* [x] 新しいデータモデル（SceneHistoryEntry）が実装されている
* [x] SceneHistoryManagerクラスが実装されている
* [x] 動的場面作成機能が実装されている
* [x] SimulationEngineの履歴再開機能が実装されている
* [x] 新しいバックエンドAPIエンドポイントが実装されている
* [x] タイムライン画面に場面作成ダイアログが実装されている
* [x] 履歴一覧表示が改善されている
* [x] 既存のアプリケーションに新機能が統合されている
* [x] 全ての新機能の基本実装が完了している
* [x] フロントエンドとバックエンドの連携が確立されている

## 14. 実装完了報告 (Implementation Complete Report)

### 🎉 実装完了！

**実装日**: 2024年12月15日
**実装期間**: 1日（4つのPhaseに分けて実装）

### 📋 実装された機能

#### 1. **場面とシミュレーションの1対1対応化** ✅
- 各シミュレーションに固有の場面が紐付けられる設計
- SceneHistoryEntryデータモデルによる統一管理
- タイムスタンプベースのシミュレーションID生成

#### 2. **タイムライン画面からの動的場面作成** ✅
- モーダルダイアログによる直感的な場面作成UI
- 場面名、場所、時間、状況、参加キャラクターの入力
- リアルタイムバリデーションとエラーハンドリング
- 自動ID生成機能

#### 3. **LINEのトーク画面のような履歴管理** ✅
- カード形式の履歴表示
- ステータス（アクティブ、一時停止、完了、アーカイブ）管理
- 展開可能な詳細情報表示
- 再開・一時停止・削除アクション

#### 4. **完全なAPI統合** ✅
- バックエンドAPI（8個のエンドポイント）実装
- フロントエンドAPI連携モジュール
- エラーハンドリングとローディング状態管理
- リアルタイムデータ同期

#### 5. **既存アプリケーションとの統合** ✅
- EnhancedTimelineコンポーネントによる置き換え
- 既存機能との互換性保持
- シームレスなUX統合

### 🔧 技術的ハイライト

- **バックエンド**: Python/FastAPI、Pydantic、新しいデータモデル
- **フロントエンド**: React/TypeScript、Framer Motion、Zustand状態管理
- **UI/UX**: ニューモーフィズムデザイン、レスポンシブ対応、アニメーション
- **API設計**: RESTful、エラーハンドリング、型安全性

### 🚀 提供される価値

1. **直感的な操作性**: その場で場面を作成してすぐシミュレーション開始
2. **継続的な物語体験**: 過去の場面から簡単に続きをプレイ
3. **効率的な管理**: LINEのような感覚での履歴管理
4. **拡張性**: 将来の機能追加に対応できる設計
5. **開発者体験**: 型安全性とエラーハンドリングによる安定性

この実装により、ユーザーは物語の進行をより自然に体験でき、開発者は拡張性の高いシステムを手に入れることができました。

## 15. 備考 (Notes)

* この変更は大きな仕様変更のため、段階的に実装を進めました
* 既存のシミュレーション履歴との互換性を保つよう注意しました
* UX設計において、LINEのトーク画面のような直感的な操作感を実現しました
* パフォーマンスを考慮し、効率的な履歴データ管理の仕組みを実装しました 